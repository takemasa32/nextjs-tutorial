# v4.0-useformstatus-introduced 実装ガイド

## 概要

v3.0 から v4.0 への移行では、より現代的なフォーム状態管理を導入し、ユーザーエクスペリエンスを大幅に向上させました。主な変更点は以下の通りです：

- **useFormStatus フックの導入**: React 19 の新機能を活用したフォーム状態管理
- **SubmitButton コンポーネントの作成**: 再利用可能なローディング状態管理
- **コンポーネント分離**: 関心の分離によるコードの可読性向上
- **型安全性の更なる向上**: FormStatus 型の活用

## アーキテクチャ変更

### 新規追加コンポーネント

```text
src/components/SubmitButton.tsx  (新規作成)
```

### 主要な変更ファイル

```text
src/app/page.tsx                 (SubmitButton統合)
src/app/notes/_actions.ts        (バリデーション改良)
src/lib/supabase/client.ts       (型注釈改良)
src/types/note.ts                (型定義調整)
src/types/utils.ts               (ユーティリティ型拡張)
```

## 詳細な変更内容

### 1. SubmitButton コンポーネントの作成

**新規作成:**

```typescript
// src/components/SubmitButton.tsx
"use client";

import { useFormStatus } from "react-dom";

interface SubmitButtonProps {
  children: React.ReactNode;
  className?: string;
}

export default function SubmitButton({
  children,
  className = "",
}: SubmitButtonProps) {
  const { pending } = useFormStatus();

  return (
    <button
      type="submit"
      disabled={pending}
      className={`${className} ${
        pending ? "opacity-50 cursor-not-allowed" : ""
      }`}
    >
      {pending ? "保存中..." : children}
    </button>
  );
}
```

**主な特徴:**

- **useFormStatus フック**: React 19 の新機能を活用
- **TypeScript サポート**: 完全な型安全性
- **アクセシビリティ**: disabled 状態の適切な処理
- **視覚的フィードバック**: loading 時の視覚的変化
- **再利用性**: 汎用的な SubmitButton コンポーネント

### 2. メインページでの統合

**変更前 (v3.0):**

```typescript
// src/app/page.tsx - 基本的なsubmitボタン
<form action={createNote} className="space-y-4">
  {/* フォームフィールド */}
  <button
    type="submit"
    className="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
  >
    ノートを作成
  </button>
</form>
```

**変更後 (v4.0):**

```typescript
// src/app/page.tsx - SubmitButton統合
import SubmitButton from "@/components/SubmitButton";

export default async function Home() {
  // ... データフェッチング

  return (
    <div className="max-w-4xl mx-auto p-6 bg-white">
      <div className="text-center mb-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-2">
          Next.js Tutorial Notes - v4.0
        </h1>
        <p className="text-gray-600">
          useFormStatus フックを使用したモダンなフォーム状態管理
        </p>
      </div>

      <form action={createNote} className="space-y-4 mb-8">
        <div>
          <label
            htmlFor="title"
            className="block text-sm font-medium text-gray-700"
          >
            タイトル
          </label>
          <input
            type="text"
            id="title"
            name="title"
            required
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
          />
        </div>
        <div>
          <label
            htmlFor="content"
            className="block text-sm font-medium text-gray-700"
          >
            内容
          </label>
          <textarea
            id="content"
            name="content"
            rows={3}
            required
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
          />
        </div>
        <SubmitButton className="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
          ノートを作成
        </SubmitButton>
      </form>

      {/* ノート一覧表示 */}
    </div>
  );
}
```

### 3. Server Actions の改良

**改良内容:**

```typescript
// src/app/notes/_actions.ts - バリデーション強化
"use server";

import { revalidatePath } from "next/cache";
import { createServerClient } from "@/lib/supabase/server";

export interface ActionResult {
  success: boolean;
  error?: string;
  data?: any;
}

export async function createNote(formData: FormData): Promise<ActionResult> {
  try {
    const supabase = createServerClient();

    const title = formData.get("title") as string;
    const content = formData.get("content") as string;

    // 強化されたバリデーション
    if (!title?.trim() || !content?.trim()) {
      return {
        success: false,
        error: "タイトルと内容は必須です。",
      };
    }

    if (title.trim().length > 100) {
      return {
        success: false,
        error: "タイトルは100文字以内で入力してください。",
      };
    }

    if (content.trim().length > 1000) {
      return {
        success: false,
        error: "内容は1000文字以内で入力してください。",
      };
    }

    const { data, error } = await supabase
      .from("notes")
      .insert({
        title: title.trim(),
        content: content.trim(),
      })
      .select()
      .single();

    if (error) {
      console.error("Database error:", error);
      return {
        success: false,
        error: "ノートの保存に失敗しました。",
      };
    }

    revalidatePath("/");
    return {
      success: true,
      data: data,
    };
  } catch (error) {
    console.error("Unexpected error:", error);
    return {
      success: false,
      error: "サーバーエラーが発生しました。",
    };
  }
}
```

### 4. 型定義の改良

**型システムの強化:**

```typescript
// src/types/note.ts - 改良版
import { Database } from "./database.types";

export type Note = Database["public"]["Tables"]["notes"]["Row"];
export type NoteInsert = Database["public"]["Tables"]["notes"]["Insert"];
export type NoteUpdate = Database["public"]["Tables"]["notes"]["Update"];

// フォーム状態管理用の型
export interface FormState {
  pending: boolean;
  error?: string;
  success?: boolean;
}
```

**ユーティリティ型の拡張:**

```typescript
// src/types/utils.ts - 拡張版
import { Database } from "./database.types";

export type Tables<T extends keyof Database["public"]["Tables"]> =
  Database["public"]["Tables"][T]["Row"];

export type Enums<T extends keyof Database["public"]["Enums"]> =
  Database["public"]["Enums"][T];

export type QueryData<T> = T extends PromiseLike<{ data: infer U }>
  ? NonNullable<U>
  : never;

export type QuerySingle<T> = T extends PromiseLike<{ data: infer U }>
  ? NonNullable<U> extends Array<any>
    ? NonNullable<U>[0]
    : NonNullable<U>
  : never;

export type QueryError<T> = T extends PromiseLike<{ error: infer U }>
  ? U
  : never;

// フォーム状態管理用のユーティリティ型
export type FormStatus = {
  pending: boolean;
  data?: FormData | null;
  method?: string | null;
  action?: string | (() => void) | null;
};
```

### 5. Supabase クライアントの改良

**型注釈の改良:**

```typescript
// src/lib/supabase/client.ts - 型安全性向上
import { createBrowserClient } from "@supabase/ssr";
import { Database } from "@/types/database.types";

export const createClient = () => {
  return createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
};
```

## テストの更新

### E2E テストの改良

```typescript
// tests/note.spec.ts - ローディング状態のテスト
import { test, expect } from "@playwright/test";

test.describe("Notes Application v4.0", () => {
  test.beforeEach(async ({ page }) => {
    await page.goto("/");
  });

  test("should show loading state when creating note", async ({ page }) => {
    await page.fill("#title", "Test Note");
    await page.fill("#content", "Test Content");

    // submit ボタンのクリック
    const submitButton = page.locator('button[type="submit"]');
    await submitButton.click();

    // ローディング状態の確認
    await expect(submitButton).toHaveText("保存中...");
    await expect(submitButton).toBeDisabled();

    // 完了後の確認
    await expect(page.locator("text=Test Note")).toBeVisible();
    await expect(submitButton).toHaveText("ノートを作成");
    await expect(submitButton).toBeEnabled();
  });

  test("should create and display notes", async ({ page }) => {
    await page.fill("#title", "Integration Test Note");
    await page.fill("#content", "This is a test note for integration testing.");
    await page.click('button[type="submit"]');

    await expect(page.locator("text=Integration Test Note")).toBeVisible();
    await expect(
      page.locator("text=This is a test note for integration testing.")
    ).toBeVisible();
  });
});
```

## パフォーマンス最適化

### 1. クライアントサイド JavaScript の最小化

- **SubmitButton**: 必要最小限のクライアントコンポーネント
- **useFormStatus**: サーバーサイドフォーム状態との統合
- **重複コードの削除**: 共通コンポーネントの活用

### 2. レンダリング最適化

- **Server Components**: 初期描画の高速化
- **選択的ハイドレーション**: 必要な部分のみクライアント側で実行
- **状態管理の最適化**: useFormStatus による効率的な状態更新

## ユーザーエクスペリエンス向上

### 1. 視覚的フィードバック

- **ローディング状態**: "保存中..." テキストの表示
- **ボタン無効化**: 重複送信の防止
- **視覚的変化**: opacity 変更による状態表示

### 2. アクセシビリティ

- **スクリーンリーダー対応**: disabled 属性の適切な使用
- **キーボードナビゲーション**: フォーカス管理の改善
- **ARIA 属性**: 状態変化の適切な通知

## 移行手順

### 1. 依存関係の確認

```bash
# React 19 の機能確認
npm list react react-dom

# 最新のNext.js確認
npm list next
```

### 2. コンポーネントの作成

```bash
# SubmitButtonコンポーネントの作成
mkdir -p src/components
# 上記のコードでファイル作成
```

### 3. 統合テスト

```bash
# 開発サーバーでの動作確認
npm run dev

# E2Eテストの実行
npm run test:e2e

# ビルドテスト
npm run build
```

## ベストプラクティス

### 1. コンポーネント設計

- **単一責任原則**: SubmitButton は状態管理のみに集中
- **再利用性**: 汎用的な props インターフェース
- **型安全性**: TypeScript による完全な型サポート

### 2. 状態管理

- **useFormStatus**: React 19 の標準 API を活用
- **サーバー状態**: Server Actions との統合
- **エラーハンドリング**: 適切なエラー境界の設定

### 3. パフォーマンス

- **選択的ハイドレーション**: 必要最小限のクライアントコード
- **状態同期**: サーバーとクライアントの効率的な同期
- **レンダリング最適化**: 不必要な再レンダリングの回避

## 次のステップ

v4.0 完了後、次は v5.0-tests-updated に進み、以下を実装します：

- 完全な Server Components への移行
- クライアントコンポーネントの最小化
- テストスイートの完全なアップデート
- 包括的な型安全性の実現

---

**注意**: この実装ガイドは、実際の Git コミット履歴に基づいて作成されています。具体的な変更内容は `git diff v3.0-form-refactored..v4.0-useformstatus-introduced` で確認できます。
