# v5.0-tests-updated: 実装ガイド

## 概要

v5.0 では、テストの更新と最終的なアーキテクチャの完成を行います。API Route を完全に削除し、Server Actions ベースの純粋な実装にします。

## 主な変更点

### 1. 不要ファイルの削除

- `src/app/api/notes/create/route.ts` - Server Actions で代替されるため削除
- `src/app/api/notes/create/route.test.ts` - 対応する API が削除されるため削除

### 2. Server Component 化

メインページを Server Component に変更して、NEXT*PUBLIC*環境変数を完全に排除：

```typescript
// Before: Client Component + fetch
"use client";
import { createClient } from "@/lib/supabase/client";

// After: Server Component + direct DB access
import { createClient } from "@/lib/supabase/server";

export default async function Home() {
  const supabase = createClient();
  const { data: notes } = await supabase
    .from("notes")
    .select()
    .order("created_at", { ascending: false });

  return <NotesDisplay notes={notes} />;
}
```

### 3. 環境変数のセキュリティ向上

- `NEXT_PUBLIC_SUPABASE_URL` → `SUPABASE_URL` (サーバーサイドのみ)
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` → `SUPABASE_ANON_KEY` (サーバーサイドのみ)

### 4. 型システムの完成

完全に Supabase 生成型ベースのシステム：

```typescript
import type { Database } from "@/types/database.types";
import type { QueryData } from "@supabase/supabase-js";

// クエリから直接型を推論
const query = supabase.from("notes").select();
type NotesData = QueryData<typeof query>;
```

## 実装手順

### Step 1: Server Component 化

1. ページコンポーネントを Server Component に変更
2. データ取得をサーバーサイドに移行
3. クライアントサイドの Supabase アクセスを削除

### Step 2: 不要ファイルの削除

```bash
rm src/app/api/notes/create/route.ts
rm src/app/api/notes/create/route.test.ts
rmdir src/app/api/notes/create
rmdir src/app/api/notes
rmdir src/app/api
```

### Step 3: 環境変数の更新

### Step 3: 環境変数の更新

`.env.local.example`:

```env
# Server-side only (secure)
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_supabase_anon_key
```

### Step 4: テストの更新

E2E テストの環境変数設定を更新：

```typescript
// playwright.config.ts
const supabaseUrl = process.env.SUPABASE_URL!;
const supabaseAnonKey = process.env.SUPABASE_ANON_KEY!;
```

## 講義のポイント

### セキュリティの向上

1. **環境変数の適切な使用**:

   - NEXT*PUBLIC*は本当に必要な場合のみ使用
   - サーバーサイドのみで DB 接続することでキーの露出を防止

2. **攻撃面の縮小**:
   - クライアントサイドの DB 接続コードを削除
   - API Route の削除により、攻撃経路を削減

### パフォーマンスの向上

1. **Server Component 活用**:

   - 初期ページロードが高速化
   - クライアントサイド JavaScript の削減

2. **ウォーターフォールの回避**:
   - データ取得がサーバーサイドで完了
   - ハイドレーション時にはデータが既に存在

### 開発体験の向上

1. **型安全性の強化**:

   - Supabase 生成型の完全活用
   - QueryData による正確な型推論

2. **テストの簡素化**:
   - API Route テストが不要
   - Server Actions テストに集約

## 確認事項

- [ ] 全テストが通ること
- [ ] プロダクションビルドが成功すること
- [ ] 環境変数が適切に設定されていること
- [ ] NEXT*PUBLIC*プレフィックスが不要な箇所で使用されていないこと
